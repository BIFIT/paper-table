<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../iron-icons/iron-icons.html">

<dom-module id="paper-table">

  <style>
    :host {
      --paper-input-container-color: #2E2E2E;
      --paper-table-header-background-color: #FFF;

      display: block;
      position: relative;
      overflow: auto;
      margin: 1rem;
      background-color: var(--paper-table-header-background-color);

      --paper-input-container: {
        display: inline-flex;
        padding: 0;
      };

      --paper-icon-button: {
        display: inline-flex;
        align-items: center;
        padding: 0;
        transition: 0.4s ease-in-out !important;
        height: 2rem;
      };

      @apply (--shadow-elevation-2dp);
    }

    .flex-container {
      display: flex;
      align-items: center;
      justify-content: flex-start;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      border: none;
      min-width: 720px;
      max-width: 100%;
    }

    thead {
      background-color: var(--paper-table-header-background-color);
      top: 0;
      left: 0;
      width: 100%;
      right: 0;
      z-index: 1;
      will-change: transform;
    }

    tbody {
      border-top: 1px solid rgba(0, 0, 0, .12);
      overflow: auto;
    }

    th {
      font-weight: lighter;
      color: rgb(168, 172, 165);
      vertical-align: bottom;
      border-bottom: 1px solid rgba(0, 0, 0, .12);
      padding: 1rem 0;
      box-shadow: 0px 2px 0px 0px #CBD1D8;
    }

    th:first-child {
      padding-left: 1em;
    }

    th:nth-last-child(2) {
      padding-right: 1em;
    }

    th:first-child paper-input {
      max-width: 3rem;
    }

    tbody tr {
      border-bottom: 1px solid #CBD1D8;
    }

    tbody tr:nth-last-child(2) {
      border: none;
    }

    tbody tr:not(:hover) iron-icon[icon="check-circle"] {
      color: var(--default-primary-color);
    }

    tbody tr:not(:hover) iron-icon[icon="cancel"] {
      color: #CBD1D8;
    }

    tbody tr:hover {
      cursor: pointer;
      background-color: #EEE !important;
    }

    td {
      text-align: left;
      padding: 0.5em;
      vertical-align: top;
      border-top: 0;
      line-height: 2;
    }

    td:first-child {
      text-align: center;
    }

    h2 {
      padding: 1rem;
      color: var(--paper-table-header-color);
      z-index: 2;
      position: relative;
    }

    .center {
      text-align: center;
    }

    iron-icon {
      position: static;
    }

    paper-input {
      text-align: left;
    }

    paper-icon-button {
      transform: rotate(-90deg);
      min-width: 1.5rem;
      max-width: 1.5rem;
    }

    .selected {
      color: #333;
    }

  </style>

  <template>

    <template is="dom-if" if="[[ hasTitle() ]]">
      <h2>[[label]]</h2>
    </template>

    <template is="dom-if" if="[[ !hasTitle() ]]">
      <br>
    </template>

    <table unresolved="">
      <thead>
      <tr>
        <template is="dom-repeat"
                  items="{{columns}}"
                  as="column">
          <th>
            <div class="flex-container">
              <paper-icon-button hidden$="[[!column.sortable]]"
                                 icon="arrow-back"
                                 name$="[[column.name]]"
                                 on-click="sortByColumn">
              </paper-icon-button>

              <paper-input no-label-float
                           hidden$="[[!column.filter]]"
                           on-keyup="filterByColumn"
                           label="[[column.label]]">
              </paper-input>

              <span hidden$="[[column.filter]]">[[column.label]]</span>
            </div>
          </th>
        </template>
      </tr>
      </thead>

      <tbody>
      <template is="dom-repeat"
                items="[[rows]]"
                as="row"
                index-as="indexNum"
                filter="[[_filterByKey(filterValue, filterColumn)]]"
                sort="[[_sortByKey(sortColumn, sortDescending)]]">

        <tr on-click="_selectElem">
          <template is="dom-repeat"
                    items="[[_rowPublicKeys(row)]]"
                    as="label">
            <td>
              <span>[[_getRowLabel(row, label)]]</span>
            </td>
          </template>

          <!--TODO: должно быть отдельно от paper-table -->
          <td class="center">
            <template is="dom-if" if="[[row._status]]">
              <iron-icon icon="check-circle"></iron-icon>
            </template>
            <template is="dom-if" if="[[!row._status]]">
              <iron-icon icon="cancel"></iron-icon>
            </template>
          </td>
        </tr>
      </template>
      </tbody>
    </table>

  </template>

  <script>"use strict";
new Polymer({
  is: 'paper-table',
  properties: {
    label: {
      type: String,
      notify: false,
      value: function() {
        return '';
      }
    },
    columns: {type: Array},
    rows: {
      type: Array,
      observer: '_changeRows'
    },
    filterValue: {type: String},
    filterColumn: {type: String},
    sortColumn: {type: String},
    sortDescending: {
      type: String,
      value: 'false'
    }
  },
  _changeRows: function() {
    this._setFirstIconSelected();
  },
  _rowPublicKeys: function(e) {
    return Object.keys(e).filter(function(item) {
      if (item.startsWith('_')) {
        return false;
      }
      return true;
    });
  },
  _getRowLabel: function(row, label) {
    return row[label];
  },
  _selectElem: function(e) {
    page.show(e.model.row._href);
  },
  hasTitle: function() {
    return !!this.getAttribute('label');
  },
  _resetIcons: function() {
    var $icons = this.querySelectorAll('th paper-icon-button');
    for (var i = 0; i < $icons.length; i++) {
      var icon = $icons[i];
      Polymer.Base.transform('rotate(-90deg)', icon);
      icon.classList.remove('selected');
    }
  },
  sortByColumn: function(e) {
    this.sortColumn = e.model.column.name;
    this._resetIcons();
    this.sortDescending = (this.sortDescending === 'true') ? 'false' : 'true';
    e.currentTarget.classList.add('selected');
    if (this.sortDescending === 'true') {
      Polymer.Base.transform('rotate(-90deg)', e.currentTarget);
    } else {
      Polymer.Base.transform('rotate(90deg)', e.currentTarget);
    }
  },
  filterByColumn: function(e) {
    this.filterValue = e.currentTarget.value;
    this.filterColumn = e.model.column.name;
  },
  _sortByKey: function(key, order) {
    var sortByKey = function(a, b) {
      var key1 = a[key];
      var key2 = b[key];
      if ((typeof key1 === 'undefined') || (typeof key2 === 'undefined')) {
        throw 'Not key detected';
      }
      if ((typeof key1 === 'string') && (typeof key2 === 'string')) {
        key1 = key1.toLowerCase();
        key2 = key2.toLowerCase();
        return ((key1 < key2) ? -1 : (key1 > key2) ? 1 : 0);
      }
      return key2 - key1;
    };
    var sortByIndex = function(a, b) {
      return b.index - a.index;
    };
    var sort = function(a, b) {
      if (b > 0) {
        return -1;
      } else if (b < 0) {
        return 1;
      } else {
        return 0;
      }
    };
    var sortInvert = function(a, b) {
      if (b > 0) {
        return 1;
      } else if (b < 0) {
        return -1;
      } else {
        return a;
      }
    };
    var sorterAsc = function(a, b) {
      var var1 = sortByIndex(b, a);
      var var2 = sortByKey(a, b);
      return sort(var1, var2);
    };
    var sorterDesc = function(a, b) {
      var var1 = sortByIndex(b, a);
      var var2 = sortByKey(a, b);
      return sortInvert(var1, var2);
    };
    if (order === 'false') {
      return sorterDesc;
    } else {
      return sorterAsc;
    }
  },
  _filterByKey: function(value, column) {
    return function(elem) {
      if (!value) {
        return true;
      }
      if (!elem) {
        return false;
      }
      switch ($traceurRuntime.typeof(elem[column])) {
        case 'number':
          if (String(elem[column]).startsWith(value)) {
            return 1;
          }
          break;
        case 'string':
          if (String(elem[column]).search(new RegExp(value, 'i')) > -1) {
            return 1;
          }
          break;
      }
    };
  },
  _setColumnsAsync: function() {
    var $__3 = this;
    var childNodes = Polymer.dom(this).childNodes;
    this.async(function() {
      var paperColumnArray = [];
      childNodes.filter(function(e) {
        return e.nodeName === 'PAPER-COLUMN';
      }).forEach(function(e) {
        paperColumnArray.push({
          label: e.getAttribute('label') || '',
          sortable: e.getAttribute('sortable') !== null,
          filter: e.getAttribute('filter') !== null,
          name: e.getAttribute('name') || ''
        });
      });
      $__3.set('columns', paperColumnArray);
      Promise.resolve();
    });
  },
  _setFirstIconSelected: function() {
    var $__3 = this;
    this.async(function() {
      var firstIconButton = $__3.$$('paper-icon-button');
      firstIconButton.classList.add('selected');
      Promise.resolve();
    }, 1);
  },
  _addScrollEvents: function() {
    var self = this;
    var scrollContainer = null;
    var thead = this.$$('thead');
    this.async(function() {
      try {
        scrollContainer = document.querySelector('#mainContainer');
        scrollContainer.onscroll = scrollHandler;
        Promise.resolve();
      } catch (e) {
        Promise.reject(e);
      }
    }, 1);
    function scrollHandler() {
      if (scrollContainer.scrollTop > 48) {
        self.transform(("translateY(" + (scrollContainer.scrollTop - 32) + "px)"), thead);
      } else {
        self.transform("translateY(0px)", thead);
      }
    }
  },
  ready: function() {
    Promise.resolve().then(this._setColumnsAsync()).then(this._addScrollEvents()).catch(console.log.bind(console));
  }
});
//# sourceURL=<compile-source>
</script>

</dom-module>
